<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:content="http://purl.org/rss/1.0/modules/content/">
    <channel>
        <title>Solide Blog</title>
        <link>https://solide-project.github.io/doc/blog</link>
        <description>Solide Blog</description>
        <lastBuildDate>Sat, 02 Mar 2024 08:47:20 GMT</lastBuildDate>
        <docs>https://validator.w3.org/feed/docs/rss2.html</docs>
        <generator>https://github.com/jpmonette/feed</generator>
        <language>en</language>
        <item>
            <title><![CDATA[ERC4337 - Paymaster]]></title>
            <link>https://solide-project.github.io/doc/blog/ethereum/erc4337/paymaster</link>
            <guid>https://solide-project.github.io/doc/blog/ethereum/erc4337/paymaster</guid>
            <pubDate>Sat, 02 Mar 2024 08:47:20 GMT</pubDate>
            <category>open-source</category>
            <category>smart-contract</category>
            <category>development-tool</category>
        </item>
        <item>
            <title><![CDATA[ERC4337 - Decoding Ethereum's EntryPoint]]></title>
            <link>https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint</link>
            <guid>https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint</guid>
            <pubDate>Sat, 02 Mar 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[<BlogCoverImage]]></description>
            <content:encoded><![CDATA[<img class="rounded-lg w-full" src="https://raw.githubusercontent.com/solide-project/docs/master/static/img/blog/ethereum-entry-point.png" alt="cover">
<iframe src="https://solidewidget.azurewebsites.net/address/1/0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789" height="400" width="300" style="border-radius:8px;width:100%;overflow:hidden"></iframe>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="basic">Basic<a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#basic" class="hash-link" aria-label="Direct link to Basic" title="Direct link to Basic">​</a></h2>
<p>Before we go into the details of the EntryPoint, we need to understand the basic flow of how the EntryPoint works. The EntryPoint is a smart contract that is used to execute <code>UserOperations</code>. The <code>UserOperation</code> is a struct that contains all the necessary information to execute a transaction. The EntryPoint is used to execute multiple UserOperations at once. This is done to save gas costs and to make the execution of transactions more efficient.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="useroperation">UserOperation<a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#useroperation" class="hash-link" aria-label="Direct link to UserOperation" title="Direct link to UserOperation">​</a></h3>
<p>The primary data structure for user interaction within the Account Abstraction framework is encapsulated in <code>interfaces/UserOperation.sol</code>. This structure is typically created by the Bundler and transmitted to the EntryPoint contract. The <code>UserOperation</code> struct comprises the following fields:</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">struct</span><span class="token plain"> </span><span class="token class-name">UserOperation</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">address</span><span class="token plain"> sender</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> nonce</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">bytes</span><span class="token plain"> initCode</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">bytes</span><span class="token plain"> callData</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> callGasLimit</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> verificationGasLimit</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> preVerificationGas</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> maxFeePerGas</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> maxPriorityFeePerGas</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">bytes</span><span class="token plain"> paymasterAndData</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">bytes</span><span class="token plain"> signature</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>An example of a <code>UserOperation</code> is provided below:</p>
<div class="language-typescript codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-typescript codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">const</span><span class="token plain"> emptyUserOp</span><span class="token operator" style="color:#063289">:</span><span class="token plain"> UserOperation </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    sender</span><span class="token operator" style="color:#063289">:</span><span class="token plain"> AddressZero</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    callData</span><span class="token operator" style="color:#063289">:</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">'0x'</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    nonce</span><span class="token operator" style="color:#063289">:</span><span class="token plain"> </span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    preVerificationGas</span><span class="token operator" style="color:#063289">:</span><span class="token plain"> </span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    verificationGasLimit</span><span class="token operator" style="color:#063289">:</span><span class="token plain"> </span><span class="token number" style="color:#063289">100000</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    callGasLimit</span><span class="token operator" style="color:#063289">:</span><span class="token plain"> </span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    maxFeePerGas</span><span class="token operator" style="color:#063289">:</span><span class="token plain"> </span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    maxPriorityFeePerGas</span><span class="token operator" style="color:#063289">:</span><span class="token plain"> </span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    signature</span><span class="token operator" style="color:#063289">:</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">'0x'</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In contrast to the traditional approach of sending signed transactions to a mempool for validation, the initial step in ERC-4337 involves dispatching an operation in the form of a <strong>UserOperation</strong>. These operations are then forwarded to an alternative mempool. Users have the capability to dispatch multiple UserOperations concurrently through a Bundler smart contract, referred to as Bundler Transactions.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="entry-point-contract-on-ethereum">Entry Point Contract on Ethereum<a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#entry-point-contract-on-ethereum" class="hash-link" aria-label="Direct link to Entry Point Contract on Ethereum" title="Direct link to Entry Point Contract on Ethereum">​</a></h3>
<p>The <strong>EntryPoint</strong> (EP) contract on Ethereum, found at <a href="https://etherscan.io/address/0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789" target="_blank" rel="noopener noreferrer">0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789</a>, is crucial for handling <code>bundlerTransactions</code>.</p>
<p>You can explore this contract using Solidity's IDE <code>${SOLIDE_URL}/1/0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789)</code></p>
<p>As of writing this, its contract version is <code>0.6.0</code> and serves as the main hub for processing batches of <code>UserOperations</code>. The contract offers two main methods: <code>handleOps</code> and <code>handleAggregatedOps</code>. We'll focus on <code>handleOps</code> for now, leaving <code>handleAggregatedOps</code> for later discussion.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="point_right-handleops">👉<!-- --> handleOps<a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#point_right-handleops" class="hash-link" aria-label="Direct link to point_right-handleops" title="Direct link to point_right-handleops">​</a></h2>
<p>The main flow of using the EntryPoint typically comes from the <code>Bundler</code> contracts which are called the <code>handleOps()</code></p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">function</span><span class="token plain"> </span><span class="token function" style="color:#b29762">handleOps</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">UserOperation</span><span class="token punctuation" style="color:#b6ad9a">[</span><span class="token punctuation" style="color:#b6ad9a">]</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">calldata</span><span class="token plain"> ops</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token builtin">address</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">payable</span><span class="token plain"> beneficiary</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">public</span><span class="token plain"> nonReentrant</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ol>
<li><strong>Non-Reentrant Modifier</strong>: This modifier prevents reentrancy attacks, ensuring the security of the smart contract.</li>
<li><strong>UserOperation Array</strong>: The <code>ops</code> array consists of <code>UserOperation</code> objects, stored in <code>calldata</code>. These objects hold data passed to the contract's entry point.</li>
<li><strong>Beneficiary Address</strong>: The <code>beneficiary</code> address is where gas refunds are sent after execution. Typically, this address corresponds to the bundler, but it can be set to any desired address.</li>
</ol>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token builtin">uint256</span><span class="token plain"> opslen </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> ops</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">UserOpInfo</span><span class="token punctuation" style="color:#b6ad9a">[</span><span class="token punctuation" style="color:#b6ad9a">]</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> opInfos </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">new</span><span class="token plain"> </span><span class="token class-name">UserOpInfo</span><span class="token punctuation" style="color:#b6ad9a">[</span><span class="token punctuation" style="color:#b6ad9a">]</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opslen</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Before executing the UserOperations, the EntryPoint will validate each UserOperation. It'll create a <code>UserOpInfo</code> array to store the information of each UserOperation.</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">uint256</span><span class="token plain"> i </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"> i </span><span class="token operator" style="color:#063289">&lt;</span><span class="token plain"> opslen</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"> i</span><span class="token operator" style="color:#063289">++</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">	UserOpInfo </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> opInfo </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> opInfos</span><span class="token punctuation" style="color:#b6ad9a">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#b6ad9a">]</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">	</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">uint256</span><span class="token plain"> validationData</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token builtin">uint256</span><span class="token plain"> pmValidationData</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">_validatePrepayment</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> ops</span><span class="token punctuation" style="color:#b6ad9a">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#b6ad9a">]</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> opInfo</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">	</span><span class="token function" style="color:#b29762">_validateAccountAndPaymasterValidationData</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> validationData</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> pmValidationData</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token builtin">address</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In order to populate the opInfos from the Bundler, the function will undergo validation check in its loops. In order to save gas it'll be in the <code>uncheck</code></p>
<p>Go to implementation information for <a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#heavy_check_mark-_validateprepayment">_validatePrepayment</a></p>
<p>After the validation of both the Account and Paymaster, the validation is checked to see if they expire in <code>_validateAccountAndPaymasterValidationData</code>. If the validation is successful, the EntryPoint will execute the UserOperations.</p>
<p>Go to implementation information for <a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#heavy_check_mark-validateaccountandpaymastervalidationdata">_validateAccountAndPaymasterValidationData</a></p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token builtin">uint256</span><span class="token plain"> collected </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">emit</span><span class="token plain"> </span><span class="token function" style="color:#b29762">BeforeExecution</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">uint256</span><span class="token plain"> i </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"> i </span><span class="token operator" style="color:#063289">&lt;</span><span class="token plain"> opslen</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"> i</span><span class="token operator" style="color:#063289">++</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    collected </span><span class="token operator" style="color:#063289">+=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">_executeUserOp</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">i</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> ops</span><span class="token punctuation" style="color:#b6ad9a">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#b6ad9a">]</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> opInfos</span><span class="token punctuation" style="color:#b6ad9a">[</span><span class="token plain">i</span><span class="token punctuation" style="color:#b6ad9a">]</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token function" style="color:#b29762">_compensate</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">beneficiary</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> collected</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>With all validation complete it'll emit an event before execution begins. Then start iterating through each user operation, executing them and adding the gas fees consumed by each operation to the total collected amount. After all operations are executed, it compensates the specified beneficiary with the total collected gas fees, transferring them to the beneficiary's address.</p>
<p>Go to implementation information for <a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#wrench-_executeuserop">_executeUserOp</a></p>
<p>Go to implementation information for <a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#dollar-_compensate">_compensate</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="heavy_check_mark-_validateprepayment">✔️<!-- --> _validatePrepayment<a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#heavy_check_mark-_validateprepayment" class="hash-link" aria-label="Direct link to heavy_check_mark-_validateprepayment" title="Direct link to heavy_check_mark-_validateprepayment">​</a></h2>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">function</span><span class="token plain"> </span><span class="token function" style="color:#b29762">_validatePrepayment</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">uint256</span><span class="token plain"> opIndex</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> UserOperation </span><span class="token keyword" style="color:#728fcb">calldata</span><span class="token plain"> userOp</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> UserOpInfo </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> outOpInfo</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">	</span><span class="token keyword" style="color:#728fcb">private</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">uint256</span><span class="token plain"> validationData</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token builtin">uint256</span><span class="token plain"> paymasterValidationData</span><span class="token punctuation" style="color:#b6ad9a">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>_validatePrepayment</code> function serves a pivotal role in upholding the integrity and safety of UserOperations within the account abstraction framework.</p>
<p>It takes in three parameters:</p>
<ul>
<li><code>opIndex</code>: The index of the operation.</li>
<li><code>userOp</code>: The UserOperation data structure containing essential information about the operation.</li>
<li><code>outOpInfo</code>: A UserOpInfo structure used for storing operation-specific data during validation.</li>
</ul>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token builtin">uint256</span><span class="token plain"> preGas </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">gasleft</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">MemoryUserOp </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> mUserOp </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> outOpInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">mUserOp</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token function" style="color:#b29762">_copyUserOpToMemory</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">userOp</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> mUserOp</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">outOpInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">userOpHash </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">getUserOpHash</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">userOp</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Initially, the function tracks the remaining gas at the start of its execution. Utilizing the built-in Solidity function <code>gasleft()</code>, it determines the amount of gas remaining within the current Ethereum transaction. <em>Throughout the call to the EntryPoint, <code>gasleft</code> is employed to inform decisions based on the gas supplied by the Bundler.</em> Subsequently, it creates a copy of the data from <code>userOp</code> into memory for efficient processing. Following this, it calculates a hash of the UserOperation data using the <code>getUserOpHash</code> function. This hash functions as a unique identifier for the operation, facilitating validation processes.</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">require</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">maxGasValues </span><span class="token operator" style="color:#063289">&lt;=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">type</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">uint120</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">max</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">"AA94 gas values overflow"</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This line of code ensures that certain numeric values within the UserOperation data, such as gas limits, do not exceed the maximum value representable by a 120-bit unsigned integer. This safeguard is implemented to mitigate the risk of overflow during subsequent calculations.</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token builtin">uint256</span><span class="token plain"> gasUsedByValidateAccountPrepayment</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">uint256</span><span class="token plain"> requiredPreFund</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">_getRequiredPrefund</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">mUserOp</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">gasUsedByValidateAccountPrepayment</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> validationData</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">_validateAccountPrepayment</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opIndex</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> userOp</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> outOpInfo</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> requiredPreFund</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The function continues by calculating the gas needed to pre-fund the operation. This calculation is based on the UserOperation data and specific conditions defined within the <code>_getRequiredPrefund</code> function. Furthermore, the function conducts validation checks using <code>_validateAccountPrepayment</code>. These checks ensure that the account <em>(Smart Contract Wallet)</em>, possesses adequate funds and allowances to cover the operation's gas costs.</p>
<p>Go to implementation information for <a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#_validateaccountprepayment">_validateAccountPrepayment</a></p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">mUserOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">paymaster </span><span class="token operator" style="color:#063289">!=</span><span class="token plain"> </span><span class="token builtin">address</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">	</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> paymasterValidationData</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">_validatePaymasterPrepayment</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opIndex</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> userOp</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> outOpInfo</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> requiredPreFund</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> gasUsedByValidateAccountPrepayment</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This next stage is optional, contingent upon the bundler's inclusion of a paymaster for the UserOperation. <em>The paymaster is an integral component in Account Abstraction as it enables users to settle transaction fees such as utilizing ERC-20 tokens rather than native tokens like ETH. Acting as an intermediary, the Paymaster gathers ERC-20 tokens from users and remits ETH to the blockchain for transaction facilitation.</em> Therefore, this aspect is a crucial addition to the EntryPoint, permitting the Bundler to cover the UserOperation costs using ERC-20 tokens instead of native tokens such as ETH.</p>
<p>Go to implementation information for <a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#_validatepaymasterprepayment">_validatePaymasterPrepayment</a></p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token builtin">uint256</span><span class="token plain"> gasUsed </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> preGas </span><span class="token operator" style="color:#063289">-</span><span class="token plain"> </span><span class="token function" style="color:#b29762">gasleft</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">userOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">verificationGasLimit </span><span class="token operator" style="color:#063289">&lt;</span><span class="token plain"> gasUsed</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">revert</span><span class="token plain"> </span><span class="token function" style="color:#b29762">FailedOp</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opIndex</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">"AA40 over verificationGasLimit"</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">outOpInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">prefund </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> requiredPreFund</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">outOpInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">contextOffset </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">getOffsetOfMemoryBytes</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">outOpInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">preOpGas </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> preGas </span><span class="token operator" style="color:#063289">-</span><span class="token plain"> </span><span class="token function" style="color:#b29762">gasleft</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token operator" style="color:#063289">+</span><span class="token plain"> userOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">preVerificationGas</span><span class="token punctuation" style="color:#b6ad9a">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After completing the necessary gas calculations and validations, the function ensures that the gas utilized during validation does not surpass the specified verification gas limit. Upon success, it finalizes the pre-funding details within the <code>outOpInfo</code> structure, encompassing the pre-fund amount, memory context offset, and pre-operation gas usage.</p>
<ul>
<li><code>outOpInfo.prefund</code> is set to the <code>requiredPreFund</code> value, which represents the maximum gas fee deducted from the deposit on EP.</li>
<li><code>outOpInfo.contextOffset</code> is designated as the offset of the context object in memory. Note that the context object is returned by the <code>Paymaster.validatePaymasterUserOp</code> call. By storing only the memory offset of the context object, we alleviate the need to pass around the entire context object while invoking internal methods.</li>
<li><code>outOpInfo.preOpGas</code> is determined as the sum of the total gas used thus far and the <code>userOp.preVerificationGas</code>.</li>
</ul>
<p>In summary, <code>_validatePrepayment</code> assumes the role of guaranteeing the validity and safety of UserOperations within the account abstraction framework. It encompasses crucial tasks such as gas tracking, hashing, validation, and pre-funding calculations, ensuring the seamless and secure execution of operations.</p>
<p>Go back to <a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#point_right-handleops">handleOps</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="_validateaccountprepayment">_validateAccountPrepayment<a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#_validateaccountprepayment" class="hash-link" aria-label="Direct link to _validateAccountPrepayment" title="Direct link to _validateAccountPrepayment">​</a></h3>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token function" style="color:#b29762">_createSenderIfNeeded</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opIndex</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> opInfo</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> op</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">initCode</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This internal method is crucial for validating the operation with a Smart Contract Wallet (SCW). Initially, it calls upon a Factory contract to create the account if required, utilizing <code>_createSenderIfNeeded</code>. The Wallet contract generated by this factory must adhere to <code>interfaces/IAccount.sol</code>, which includes the <code>validateUserOp</code> function. This function is essential for validating the UserOp's signature, enabling the EntryPoint to execute operations on a Wallet account.</p>
<p>Once the Smart Contract Wallet is deemed valid for further validation, the method proceeds to perform calculations on the gas funds and validate the <code>validateUserOp</code> function on the SCW if and only if <code>paymaster == address(0)</code>. This condition signifies that the SCW, either passed or generated, will be responsible for covering the current UserOperation execution(s).</p>
<p><strong>Important stage in handleOps</strong>
At this point, the EntryPoint call stack should <code>handleOps.validatePrePayment._validateAccountPrepayment</code>, where the EntryPoint is validating that the SCW has enough gas to cover the UserOperation.</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">try </span><span class="token function" style="color:#b29762">IAccount</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">sender</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">validateUserOp</span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain">gas </span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> mUserOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">verificationGasLimit</span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">op</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> opInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">userOpHash</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> missingAccountFunds</span><span class="token punctuation" style="color:#b6ad9a">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><em>There is also the introduction of reverting the entire transaction if validations fail from the SCW or the call runs out of gas.  Mainly the <code>FailedOp</code> will revert the transaction.</em></p>
<p>Upon successful validation, both <code>gasUsedByValidateAccountPrepayment</code> and <code>validationData</code> provided by the SCW through its <code>IAccount</code> interface are captured. It is crucial that the validation logic is tailored and executed according to each user's preferences and requirements.</p>
<p>Go back to <a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#heavy_check_mark-_validateprepayment">_validatePrepayment</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="_validatepaymasterprepayment">_validatePaymasterPrepayment<a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#_validatepaymasterprepayment" class="hash-link" aria-label="Direct link to _validatePaymasterPrepayment" title="Direct link to _validatePaymasterPrepayment">​</a></h3>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token builtin">uint256</span><span class="token plain"> preGas </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">gasleft</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">MemoryUserOp </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> mUserOp </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> opInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">mUserOp</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token builtin">address</span><span class="token plain"> paymaster </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> mUserOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">paymaster</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">DepositInfo </span><span class="token keyword" style="color:#728fcb">storage</span><span class="token plain"> paymasterInfo </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> deposits</span><span class="token punctuation" style="color:#b6ad9a">[</span><span class="token plain">paymaster</span><span class="token punctuation" style="color:#b6ad9a">]</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token builtin">uint256</span><span class="token plain"> deposit </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> paymasterInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">deposit</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">deposit </span><span class="token operator" style="color:#063289">&lt;</span><span class="token plain"> requiredPreFund</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">revert</span><span class="token plain"> </span><span class="token function" style="color:#b29762">FailedOp</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opIndex</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">"AA31 paymaster deposit too low"</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Similarly to the <code>_validateAccountPrepayment</code>, this time, it'll check the paymaster's deposit balance in EP. If there is enough despot compared to the provided, it'll deduct the that the the requiredPreFund from the Paymaster's deposit,</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">MemoryUserOp </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> mUserOp </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> opInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">mUserOp</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token builtin">uint256</span><span class="token plain"> verificationGasLimit </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> mUserOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">verificationGasLimit</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">require</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">verificationGasLimit </span><span class="token operator" style="color:#063289">&gt;</span><span class="token plain"> gasUsedByValidateAccountPrepayment</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">"AA41 too little verificationGas"</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token builtin">uint256</span><span class="token plain"> gas </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> verificationGasLimit </span><span class="token operator" style="color:#063289">-</span><span class="token plain"> gasUsedByValidateAccountPrepayment</span><span class="token punctuation" style="color:#b6ad9a">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>gasUsedByValidateAccountPrepayment</code> calculated by the Account validation, is used to calculate the gas required to pay back the bundler. This is done via <code>_getRequiredPrefund</code>. Since the EntryPoint is executing the UserOperations, this means that EntryPoint must ensure it has enough gas to execute those UserOperations and in order for the Bundler to obtain the gas, depends on whether a Paymaster is set up or the Smart Contract Wallet provided.</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">paymasterInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">deposit </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> deposit </span><span class="token operator" style="color:#063289">-</span><span class="token plain"> requiredPreFund</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After deducting the deposit as mentioned call the validationOp's <code>validatePaymasterUserOp</code> for paymaster of <code>interfaces/IPaymaster.sol</code> and with the &nbsp;<code>userOp.verificationGasLimit</code>&nbsp;as gas limit and return the validation Data.</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token function" style="color:#b29762">IPaymaster</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">paymaster</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">validatePaymasterUserOp</span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain">gas</span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> gas</span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">op</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> opInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">userOpHash</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> requiredPreFund</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">bytes</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> _context</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token builtin">uint256</span><span class="token plain"> _validationData</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This will return <em>context object</em> and <code>validationData</code>.</p>
<p>Go back to <a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#heavy_check_mark-_validateprepayment">_validatePrepayment</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="heavy_check_mark-validateaccountandpaymastervalidationdata">✔️<!-- --> validateAccountAndPaymasterValidationData<a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#heavy_check_mark-validateaccountandpaymastervalidationdata" class="hash-link" aria-label="Direct link to heavy_check_mark-validateaccountandpaymastervalidationdata" title="Direct link to heavy_check_mark-validateaccountandpaymastervalidationdata">​</a></h2>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">function</span><span class="token plain"> </span><span class="token function" style="color:#b29762">_validateAccountAndPaymasterValidationData</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">uint256</span><span class="token plain"> opIndex</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token builtin">uint256</span><span class="token plain"> validationData</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token builtin">uint256</span><span class="token plain"> paymasterValidationData</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">address</span><span class="token plain"> expectedAggregator</span><span class="token punctuation" style="color:#b6ad9a">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>validateAccountAndPaymasterValidationData</code> serves to validate the validation data from both the Smart Contract Wallet (SCW) and Paymaster. It verifies if the validation data has expired and reverts the transaction if it has. Notably, in the Ethereum EntryPoint, the <code>address(0)</code> represents the <code>expectedAggregator</code>.</p>
<p>Before unpacking the validationData, An example of validation data is as follows as taken by <code>account-abstraction/ethereum/contracts/TokenPaymaster.sol</code>. <em>Note this is just an example, other Paymaster's or SCW validation will have different validation data depending on it implementation.</em></p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">validationResult </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">_packValidationData</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">	</span><span class="token boolean" style="color:#728fcb">false</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">	</span><span class="token builtin">uint48</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">cachedPriceTimestamp </span><span class="token operator" style="color:#063289">+</span><span class="token plain"> tokenPaymasterConfig</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">priceMaxAge</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">	</span><span class="token number" style="color:#063289">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The validationData comprises three components, which are essential for the EntryPoint to validate the UserOperation,</p>
<ul>
<li>Aggregator: This value signifies the success of the aggregator. A value of <code>0</code> indicates a successful aggregator. For instance, if <code>false</code> is provided, it results in the value <code>0</code>, indicating success.</li>
<li>ValidUntil: This represents the start time when the signature is valid.</li>
<li>ValidAfter: This denotes the end time when the signature is valid.</li>
</ul>
<p>These components collectively determine whether signature verification was successful. The primary implementation of parsing the validationData is outlined in <code>Helper.sol</code> within the <code>_parseValidationData</code> function. In essence, this method extracts the aggregator value (an <code>address</code>), the validUntil timestamp (a <code>uint48</code>), and the validAfter timestamp (a <code>uint48</code>) from the validationData. If the validUntil value is 0, as observed in the example provided, it signifies that the signature is valid until the maximum value of <code>uint48</code>.</p>
<p>Since both validationData and paymasterValidationData undergo validation in a similar manner, we'll focus on the paymasterValidationData. The validation process involves comparing these values with the current block timestamp in the EntryPoint to ascertain their validity.</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token builtin">address</span><span class="token plain"> pmAggregator</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">pmAggregator</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> outOfTimeRange</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">_getValidationData</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">paymasterValidationData</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">pmAggregator </span><span class="token operator" style="color:#063289">!=</span><span class="token plain"> </span><span class="token builtin">address</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">	</span><span class="token keyword" style="color:#728fcb">revert</span><span class="token plain"> </span><span class="token function" style="color:#b29762">FailedOp</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opIndex</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">"AA34 signature error"</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">outOfTimeRange</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">	</span><span class="token keyword" style="color:#728fcb">revert</span><span class="token plain"> </span><span class="token function" style="color:#b29762">FailedOp</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opIndex</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">"AA32 paymaster expired or not due"</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Hence if we go back to the EntryPoint where it'll parse the above <code>validationResult</code> as <code>paymasterValidationData</code> we see it extracts the <code>pmAggregator</code> variable represents the aggregator status obtained from the paymasterValidationData. A value of <code>0</code> indicates a successful aggregator, while <code>1</code> implies an expired aggregator. With this, if <code>pmAggregator</code> is assigned the value of <code>address(0)</code>, it signifies that the aggregator is successful as it has the value of <code>0</code>.</p>
<p>Furthermore, validation is conducted by comparing the current block timestamp with the validUntil and validAfter timestamps obtained from the validation data. The <code>outOfTimeRange</code> variable is set based on whether the current timestamp exceeds the validUntil timestamp or falls before the validAfter timestamp. If <code>outOfTimeRange</code> is <code>true</code>, it indicates that the paymaster has expired or the operation is not yet due.</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">outOfTimeRange </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> block</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">timestamp </span><span class="token operator" style="color:#063289">&gt;</span><span class="token plain"> data</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">validUntil </span><span class="token operator" style="color:#063289">||</span><span class="token plain"> block</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">timestamp </span><span class="token operator" style="color:#063289">&lt;</span><span class="token plain"> data</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">validAfter</span><span class="token punctuation" style="color:#b6ad9a">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>In summary, the code snippet checks the status of the aggregator and verifies the validity of the paymaster based on timestamps, ensuring that the operation is executed within the designated time range. If any discrepancy is detected, the function reverts the transaction with an appropriate error message, such as "signature error" or "paymaster expired or not due."</p>
<p>Go back to <a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#point_right-handleops">handleOps</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="numbermarker">numberMarker()<a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#numbermarker" class="hash-link" aria-label="Direct link to numberMarker()" title="Direct link to numberMarker()">​</a></h3>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token comment" style="color:#b6ad9a">//place the NUMBER opcode in the code.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token comment" style="color:#b6ad9a">// this is used as a marker during simulation, as this OP is completely banned from the simulated code of the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token comment" style="color:#b6ad9a">// account and paymaster.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">function</span><span class="token plain"> </span><span class="token function" style="color:#b29762">numberMarker</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">internal</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">view</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">assembly</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token function" style="color:#b29762">mstore</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token function" style="color:#b29762">number</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>This function is mainly useful for the method <code>simulateValidation</code>, for tracing and checkpoints throughout the code. For our purpose, we don't need to really worry about this.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="wrench-_executeuserop">🔧<!-- --> _executeUserOp<a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#wrench-_executeuserop" class="hash-link" aria-label="Direct link to wrench-_executeuserop" title="Direct link to wrench-_executeuserop">​</a></h2>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">function</span><span class="token plain"> </span><span class="token function" style="color:#b29762">_executeUserOp</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">uint256</span><span class="token plain"> opIndex</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> UserOperation </span><span class="token keyword" style="color:#728fcb">calldata</span><span class="token plain"> userOp</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> UserOpInfo </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> opInfo</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">private</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">uint256</span><span class="token plain"> collected</span><span class="token punctuation" style="color:#b6ad9a">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token builtin">bytes</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> context </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">getMemoryBytesFromOffset</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">contextOffset</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The code begins by retrieving the context from memory. The context is stored as a byte array and contains essential information needed for the <code>Paymaster.postOp</code> function.</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">try </span><span class="token keyword" style="color:#728fcb">this</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">innerHandleOp</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">userOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">callData</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> opInfo</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> _actualGasCost</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    collected </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> _actualGasCost</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The code then attempts to execute the UserOperation by invoking the <code>innerHandleOp</code> function. This function, implemented by the Paymaster, takes <code>userOp.callData</code>, <code>opInfo</code>, and <code>context</code> as parameters. Upon invocation, <code>innerHandleOp</code> returns the actual gas cost incurred by the operation, which is subsequently added to the <code>collected</code> variable.</p>
<p>Go to implementation information for <a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#innerhandleop">innerHandleOp</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="innerhandleop">innerHandleOp<a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#innerhandleop" class="hash-link" aria-label="Direct link to innerHandleOp" title="Direct link to innerHandleOp">​</a></h3>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">function</span><span class="token plain"> </span><span class="token function" style="color:#b29762">innerHandleOp</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">bytes</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> callData</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    UserOpInfo </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> opInfo</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">bytes</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">calldata</span><span class="token plain"> context</span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">external</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">uint256</span><span class="token plain"> actualGasCost</span><span class="token punctuation" style="color:#b6ad9a">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The <code>innerHandleOp</code> method is invoked to execute the <code>UserOperation</code> calldata on the wallet contract. Leveraging the <code>Exec</code> solidity library, available in <code>util/Exec.sol</code>, developers gain access to a range of utility functions designed for diverse contract calls. These include regular <em>call</em>, <em>staticcall</em>, and <em>delegatecall</em> functionalities, along with features for retrieving return data and reverting with explicit byte arrays. Such capabilities empower developers to interact flexibly and efficiently with other contracts directly within Solidity contracts, seamlessly managing value transfers and data retrieval. In the following code snippet, <code>Exec.call</code> is utilized—a low-level call function—utilizing the calldata provided by <code>userOp.callData</code>.</p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">callData</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">length </span><span class="token operator" style="color:#063289">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">bool</span><span class="token plain"> success </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> Exec</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">call</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">mUserOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> callData</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> callGasLimit</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token operator" style="color:#063289">!</span><span class="token plain">success</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token builtin">bytes</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> result </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> Exec</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">getReturnData</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">REVERT_REASON_MAX_LEN</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">length </span><span class="token operator" style="color:#063289">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">            </span><span class="token keyword" style="color:#728fcb">emit</span><span class="token plain"> </span><span class="token function" style="color:#b29762">UserOperationRevertReason</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">userOpHash</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> mUserOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> mUserOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">nonce</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        mode </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> IPaymaster</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">PostOpMode</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">opReverted</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">unchecked </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> actualGas </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> preGas </span><span class="token operator" style="color:#063289">-</span><span class="token plain"> </span><span class="token function" style="color:#b29762">gasleft</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token operator" style="color:#063289">+</span><span class="token plain"> opInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">preOpGas</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">//note: opIndex is ignored (relevant only if mode==postOpReverted, which is only possible outside of innerHandleOp)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">return</span><span class="token plain"> </span><span class="token function" style="color:#b29762">_handlePostOp</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> mode</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> opInfo</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> actualGas</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Go to implementation information for <a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#_handlepostop">_handlePostOp</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="_handlepostop">_handlePostOp<a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#_handlepostop" class="hash-link" aria-label="Direct link to _handlePostOp" title="Direct link to _handlePostOp">​</a></h3>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">function</span><span class="token plain"> </span><span class="token function" style="color:#b29762">_handlePostOp</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">uint256</span><span class="token plain"> opIndex</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> IPaymaster</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">PostOpMode mode</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> UserOpInfo </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> opInfo</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token builtin">bytes</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> context</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token builtin">uint256</span><span class="token plain"> actualGas</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">private</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">uint256</span><span class="token plain"> actualGasCost</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token builtin">address</span><span class="token plain"> refundAddress</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">MemoryUserOp </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> mUserOp </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> opInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">mUserOp</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token builtin">uint256</span><span class="token plain"> gasPrice </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> </span><span class="token function" style="color:#b29762">getUserOpGasPrice</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">mUserOp</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token builtin">address</span><span class="token plain"> paymaster </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> mUserOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">paymaster</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">paymaster </span><span class="token operator" style="color:#063289">==</span><span class="token plain"> </span><span class="token builtin">address</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    refundAddress </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> mUserOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    refundAddress </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> paymaster</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token comment" style="color:#b6ad9a">// ...</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>When a paymaster is specified and its validation results in a non-empty context, the surplus amount is reimbursed to the account or paymaster, depending on its involvement in the transaction request. As mentioned, the following code executes the <code>IPaymaster</code>'s <code>postOp</code> function, which is another essential method similar to <code>validatePaymasterUserOp</code>.</p>
<p><em>The <code>postOp()</code> function acts as a post-execution hook after completing a user operation. It manages tasks to be executed upon successful validation of the user operation, such as handling custom token payments for transaction fees. For example, if a user chooses to pay with an ERC-20 token, the entry point invokes <code>postOp()</code> after executing the operation and provides information about gas consumption. Importantly, access to <code>postOp()</code> is contingent upon the validation context generated by <code>validatePaymasterUserOp()</code> not being null. This mechanism simplifies the process of managing token payments and facilitates smooth transaction processing on the blockchain.</em></p>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">length </span><span class="token operator" style="color:#063289">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    actualGasCost </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> actualGas </span><span class="token operator" style="color:#063289">*</span><span class="token plain"> gasPrice</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">mode </span><span class="token operator" style="color:#063289">!=</span><span class="token plain"> IPaymaster</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">PostOpMode</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">postOpReverted</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token function" style="color:#b29762">IPaymaster</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">paymaster</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">postOp</span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain">gas </span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> mUserOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">verificationGasLimit</span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">mode</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> actualGasCost</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token comment" style="color:#b6ad9a">// solhint-disable-next-line no-empty-blocks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        try </span><span class="token function" style="color:#b29762">IPaymaster</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">paymaster</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">postOp</span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain">gas </span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> mUserOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">verificationGasLimit</span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">mode</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> actualGasCost</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        catch </span><span class="token function" style="color:#b29762">Error</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">string</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">memory</span><span class="token plain"> reason</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">            </span><span class="token keyword" style="color:#728fcb">revert</span><span class="token plain"> </span><span class="token function" style="color:#b29762">FailedOp</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opIndex</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token builtin">string</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token function" style="color:#b29762">concat</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token string" style="color:#728fcb">"AA50 postOp reverted: "</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> reason</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        catch </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">            </span><span class="token keyword" style="color:#728fcb">revert</span><span class="token plain"> </span><span class="token function" style="color:#b29762">FailedOp</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opIndex</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">"AA50 postOp revert"</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">        </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token plain">actualGas </span><span class="token operator" style="color:#063289">+=</span><span class="token plain"> preGas </span><span class="token operator" style="color:#063289">-</span><span class="token plain"> </span><span class="token function" style="color:#b29762">gasleft</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">actualGasCost </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> actualGas </span><span class="token operator" style="color:#063289">*</span><span class="token plain"> gasPrice</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">prefund </span><span class="token operator" style="color:#063289">&lt;</span><span class="token plain"> actualGasCost</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">revert</span><span class="token plain"> </span><span class="token function" style="color:#b29762">FailedOp</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opIndex</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">"AA51 prefund below actualGasCost"</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token builtin">uint256</span><span class="token plain"> refund </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> opInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">prefund </span><span class="token operator" style="color:#063289">-</span><span class="token plain"> actualGasCost</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token function" style="color:#b29762">_incrementDeposit</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">refundAddress</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> refund</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token builtin">bool</span><span class="token plain"> success </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> mode </span><span class="token operator" style="color:#063289">==</span><span class="token plain"> IPaymaster</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">PostOpMode</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">opSucceeded</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">emit</span><span class="token plain"> </span><span class="token function" style="color:#b29762">UserOperationEvent</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">opInfo</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">userOpHash</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> mUserOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">sender</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> mUserOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">paymaster</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> mUserOp</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">nonce</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> success</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> actualGasCost</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> actualGas</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>After determining the refund address and ensuring that the paymaster context isn't empty, the code proceeds to calculate the actual gas usage and its associated cost during the execution of a smart contract operation. It then verifies whether the pre-funded amount is adequate to cover the gas cost. If not, the transaction is reverted. Any excess pre-funded amount is calculated as a refund and subsequently added to the deposit of the specified address. Finally, the success status of the operation is determined based on the paymaster's mode setting.</p>
<p>Additionally:</p>
<ul>
<li>The <code>_incrementDeposit</code> function in the <code>StakeManager</code> contract is invoked to increase the paymaster's deposit by the actual gas cost.</li>
<li>The <code>actualGasCost = actualGas * gasPrice</code> calculation determines the actual gas cost of the operation, which is stored as the value of <code>collected</code> in the <code>handleOps</code> function.</li>
</ul>
<p>Go back to <a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#point_right-handleops">handleOps</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dollar-_compensate">💵<!-- --> _compensate<a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#dollar-_compensate" class="hash-link" aria-label="Direct link to dollar-_compensate" title="Direct link to dollar-_compensate">​</a></h2>
<div class="language-solidity codeBlockContainer_Ckt0 theme-code-block" style="--prism-background-color:#faf8f5;--prism-color:#728fcb"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-solidity codeBlock_bY9V thin-scrollbar" style="background-color:#faf8f5;color:#728fcb"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#728fcb"><span class="token comment" style="color:#b6ad9a">/**</span><br></span><span class="token-line" style="color:#728fcb"><span class="token comment" style="color:#b6ad9a"> * compensate the caller's beneficiary address with the collected fees of all UserOperations.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token comment" style="color:#b6ad9a"> * @param beneficiary the address to receive the fees</span><br></span><span class="token-line" style="color:#728fcb"><span class="token comment" style="color:#b6ad9a"> * @param amount amount to transfer.</span><br></span><span class="token-line" style="color:#728fcb"><span class="token comment" style="color:#b6ad9a"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token keyword" style="color:#728fcb">function</span><span class="token plain"> </span><span class="token function" style="color:#b29762">_compensate</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">address</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">payable</span><span class="token plain"> beneficiary</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token builtin">uint256</span><span class="token plain"> amount</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token keyword" style="color:#728fcb">internal</span><span class="token plain"> </span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">require</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">beneficiary </span><span class="token operator" style="color:#063289">!=</span><span class="token plain"> </span><span class="token builtin">address</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token number" style="color:#063289">0</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">"AA90 invalid beneficiary"</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token builtin">bool</span><span class="token plain"> success</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token plain"> </span><span class="token operator" style="color:#063289">=</span><span class="token plain"> beneficiary</span><span class="token punctuation" style="color:#b6ad9a">.</span><span class="token plain">call</span><span class="token punctuation" style="color:#b6ad9a">{</span><span class="token plain">value </span><span class="token punctuation" style="color:#b6ad9a">:</span><span class="token plain"> amount</span><span class="token punctuation" style="color:#b6ad9a">}</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token string" style="color:#728fcb">""</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain">    </span><span class="token keyword" style="color:#728fcb">require</span><span class="token punctuation" style="color:#b6ad9a">(</span><span class="token plain">success</span><span class="token punctuation" style="color:#b6ad9a">,</span><span class="token plain"> </span><span class="token string" style="color:#728fcb">"AA91 failed send to beneficiary"</span><span class="token punctuation" style="color:#b6ad9a">)</span><span class="token punctuation" style="color:#b6ad9a">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#728fcb"><span class="token plain"></span><span class="token punctuation" style="color:#b6ad9a">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>The final step is to compensate the beneficiary with the collected fees. The collected fees are transferred to the beneficiary address. The beneficiary address can be any address where the bundler wants to receive the refund as provided in the <code>handleOps</code>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="conclusion">Conclusion<a href="https://solide-project.github.io/doc/blog/ethereum/erc4337/entrypoint#conclusion" class="hash-link" aria-label="Direct link to Conclusion" title="Direct link to Conclusion">​</a></h2>
<p>In conclusion, the EntryPoint efficiently executes the bundled UserOperations and ensures fair compensation for the beneficiary by collecting fees. This is the flow of <code>handleOp</code>. There is also <code>handleAggregatorOp</code>. Note also the EntryPoint extends <code>StakeManger</code> found in <code>core/StakeManger.sol</code> which as mentioned is responsible for managing <code>deposits</code> and stakes to ensure reimbursement for beneficiaries during the execution of handleOps and handleAggregatedOps functions. Deposits represent balances used to cover the costs of UserOperations, while stakes are values locked for a specified duration by paymasters, crucial for the reputation system.  To learn more about the EIP proposal and its specifications, you can refer to the official document <a href="https://eips.ethereum.org/EIPS/eip-4337" target="_blank" rel="noopener noreferrer">here</a>.</p>]]></content:encoded>
            <category>erc4337</category>
            <category>account-abstraction</category>
            <category>ethereum</category>
            <category>entry-point</category>
        </item>
        <item>
            <title><![CDATA[Welcome]]></title>
            <link>https://solide-project.github.io/doc/blog/welcome</link>
            <guid>https://solide-project.github.io/doc/blog/welcome</guid>
            <pubDate>Wed, 21 Feb 2024 00:00:00 GMT</pubDate>
            <description><![CDATA[Welcome to Solide]]></description>
            <content:encoded><![CDATA[<p>Welcome to Solide</p>]]></content:encoded>
            <category>open-source</category>
            <category>smart-contract</category>
            <category>development-tool</category>
        </item>
    </channel>
</rss>